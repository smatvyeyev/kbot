helm create helm
helm lint ./helm
helm template kbot ./helm
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
k3d cluster create kbot
kubectl cluster-info

kubectl create secret generic kbot

echo -n '6070479572:AAHm-6DGPwZGmOoeSfP9Uz_wBS-Ux_TJbWE' | base64
NjA3MDQ3OTU3MjpBQUhtLTZER1B3WkdtT29lU2ZQOVV6X3dCUy1VeF9USmJXRQ==

kubectl edit  secret  kbot
secret/kbot edited
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl describe  secret  kbot
Name:         kbot
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
token:  46 bytes

helm template kbot ./helm | kubectl apply --dry-run -f -
W0701 17:10:09.414253   26307 helpers.go:692] --dry-run is deprecated and can be replaced with --dry-run=client.
deployment.apps/kbot-helm created (dry run)

helm template kbot ./helm | kubectl apply --dry-run=client  -f -
deployment.apps/kbot-helm created (dry run)

helm template kbot ./helm --set secret.key="6070479572:AAHm-6DGPwZGmOoeSfP9Uz_wBS-Ux_TJbWE" | kubectl apply --dry-run=client -f - -o yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"labels":{"app.kubernetes.io/instance":"kbot","app.kubernetes.io/managed-by":"Helm","app.kubernetes.io/name":"helm","app.kubernetes.io/version":"1.16.0","helm.sh/chart":"helm-0.1.0"},"name":"kbot-helm","namespace":"default"},"spec":{"replicas":1,"selector":{"matchLabels":{"app.kubernetes.io/instance":"kbot","app.kubernetes.io/name":"helm"}},"template":{"metadata":{"labels":{"app.kubernetes.io/instance":"kbot","app.kubernetes.io/name":"helm"}},"spec":{"containers":[{"env":[{"name":"TELE_TOKEN","valueFROM":{"secretKeyRef":{"key":"token","name":"kbot"}}}],"image":"smatvyeyev/kbot/helm:v1.0.5-af93f23-arm64-amd64","name":"helm","securityContext":{},"volumeMounts":[{"mountPath":"/dev/mem","name":"dev-mem"}]}],"dnsConfig":{"nameservers":["1.1.1.1"]},"securityContext":{},"volumes":[{"hostPath":{"path":"/dev/mem","type":""},"name":"dev-mem"}]}}}}
  labels:
    app.kubernetes.io/instance: kbot
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: helm
    app.kubernetes.io/version: 1.16.0
    helm.sh/chart: helm-0.1.0
  name: kbot-helm
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/instance: kbot
      app.kubernetes.io/name: helm
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: kbot
        app.kubernetes.io/name: helm
    spec:
      containers:
      - env:
        - name: TELE_TOKEN
          valueFROM:
            secretKeyRef:
              key: token
              name: kbot
        image: smatvyeyev/kbot/helm:v1.0.5-af93f23-arm64-amd64
        name: helm
        securityContext: {}
        volumeMounts:
        - mountPath: /dev/mem
          name: dev-mem
      dnsConfig:
        nameservers:
        - 1.1.1.1
      securityContext: {}
      volumes:
      - hostPath:
          path: /dev/mem
          type: ""
        name: dev-mem


  $ helm template kbot ./helm | kubectl apply -f -
Error from server (BadRequest): error when creating "STDIN": Deployment in version "v1" cannot be handled as a Deployment: strict decoding error: unknown field "spec.template.spec.containers[0].env[0].valueFROM"


read -s TELE_TOKEN
@smatvyeyev ➜ /workspaces/kbot (helm2) $ echo $TELE_TOKEN

1 спосіб (ручний): перед/після деплою
kubectl create secret generic kbot --from-literal=token=$TELE_TOKEN


NB! треба оновити entrypoint в dockerfile і додати туди start / ENTRYPOINT ["./kbot","start"]

kubectl get po
NAME                         READY   STATUS             RESTARTS   AGE
kbot-helm-test-connection    0/1     Error              0          5h24m
kbot-helm-6dfb89465c-qjn6r   0/1     ImagePullBackOff   0          3m33s
kbot-helm-5bc5cb5c8f-4fxz7   0/1     ErrImagePull       0          31s
@smatvyeyev ➜ /workspaces/kbot (helm2) $ helm list
NAME    NAMESPACE       REVISION        UPDATED STATUS  CHART   APP VERSION
@smatvyeyev ➜ /workspaces/kbot (helm2) $ helm template kbot ./helm | kubectl apply -f -
deployment.apps/kbot created
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl get po
NAME                         READY   STATUS             RESTARTS   AGE
kbot-helm-test-connection    0/1     Error              0          5h32m
kbot-helm-5bc5cb5c8f-4fxz7   0/1     ImagePullBackOff   0          8m8s
kbot-846c4c7dd6-hpptb        0/1     ErrImagePull       0          13s
kbot-helm-6dfb89465c-qjn6r   0/1     ErrImagePull       0          11m
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  po
error: resource(s) were provided, but no name was specified
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  po -all
error: unknown shorthand flag: 'a' in -all
See 'kubectl delete --help' for usage.
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  po -a
error: unknown shorthand flag: 'a' in -a
See 'kubectl delete --help' for usage.
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  po --all
pod "kbot-helm-test-connection" deleted
pod "kbot-helm-5bc5cb5c8f-4fxz7" deleted
pod "kbot-helm-6dfb89465c-qjn6r" deleted
pod "kbot-846c4c7dd6-hpptb" deleted
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl get po
NAME                         READY   STATUS         RESTARTS   AGE
kbot-helm-6dfb89465c-m26qg   0/1     ErrImagePull   0          7s
kbot-846c4c7dd6-wzc4l        0/1     ErrImagePull   0          7s
kbot-helm-5bc5cb5c8f-5g2n8   0/1     ErrImagePull   0          7s
@smatvyeyev ➜ /workspaces/kbot (helm2) $ helm list
NAME    NAMESPACE       REVISION        UPDATED STATUS  CHART   APP VERSION
@smatvyeyev ➜ /workspaces/kbot (helm2) $ helm list -a
NAME    NAMESPACE       REVISION        UPDATED STATUS  CHART   APP VERSION
@smatvyeyev ➜ /workspaces/kbot (helm2) $ helm list -all
NAME    NAMESPACE       REVISION        UPDATED STATUS  CHART   APP VERSION
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl get deployments.apps 
NAME        READY   UP-TO-DATE   AVAILABLE   AGE
kbot        0/1     1            0           2m4s
kbot-helm   0/1     1            0           13m
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  deployments.apps 
error: resource(s) were provided, but no name was specified
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  deployments.apps --all
deployment.apps "kbot" deleted
deployment.apps "kbot-helm" deleted
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl get deployments.apps 
No resources found in default namespace.
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl get po
No resources found in default namespace.
@smatvyeyev ➜ /workspaces/kbot (helm2) $ kubectl delete  po --all


run with docker run -e TELE_TOKEN=6070479572:AAHm-6DGPwZGmOoeSfP9Uz_wBS-Ux_TJbWE a2c4d794a999

make image

helm package ./helm --version=0.1.1 
Successfully packaged chart and saved it to: /Users/sergiy.matvyeyev/Library/Mobile Documents/com~apple~CloudDocs/dvp_course/t5/code_session/kbot/kbot-0.1.1.tgz
➜  kbot git:(main) ✗ gh release create
? Choose a tag v1.0.8
? Title (optional) v1.0.8
? Release notes Write using git tag message as template
? Is this a prerelease? No
? Submit? Publish release
HTTP 422: Validation Failed (https://api.github.com/repos/smatvyeyev/kbot/releases)
Release.tag_name already exists
➜  kbot git:(main) ✗ gh release create                      
? Choose a tag Create a new tag
? Tag name v1.0.9
? Title (optional) v1.0.9
? Release notes Write using generated notes as template
? Is this a prerelease? No
? Submit? Publish release
https://github.com/smatvyeyev/kbot/releases/tag/v1.0.9

gh release list
➜  kbot git:(main) ✗ gh release upload v1.0.9 kbot-0.1.1.tgz 
Successfully uploaded 1 asset to v1.0.9

